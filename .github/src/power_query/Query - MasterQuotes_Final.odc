<html xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/x-ms-odc; charset=utf-8">
<meta name=ProgId content=ODC.Database>
<meta name=SourceType content=OLEDB>
<title>Query - MasterQuotes_Final</title>
<xml id=docprops><o:DocumentProperties
  xmlns:o="urn:schemas-microsoft-com:office:office"
  xmlns="http://www.w3.org/TR/REC-html40">
  <o:Description>Connection to the 'MasterQuotes_Final' query in the workbook.</o:Description>
  <o:Name>Query - MasterQuotes_Final</o:Name>
 </o:DocumentProperties>
</xml><xml id=msodc><odc:OfficeDataConnection
  xmlns:odc="urn:schemas-microsoft-com:office:odc"
  xmlns="http://www.w3.org/TR/REC-html40">
  <odc:PowerQueryConnection odc:Type="OLEDB">
   <odc:ConnectionString>Provider=Microsoft.Mashup.OleDb.1;Data Source=$Workbook$;Location=MasterQuotes_Final;Extended Properties=&quot;&quot;</odc:ConnectionString>
   <odc:CommandType>SQL</odc:CommandType>
   <odc:CommandText>SELECT * FROM [MasterQuotes_Final]</odc:CommandText>
  </odc:PowerQueryConnection>
  <odc:PowerQueryMashupData>&lt;Mashup xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://schemas.microsoft.com/DataMashup&quot;&gt;&lt;Client&gt;EXCEL&lt;/Client&gt;&lt;Version&gt;2.132.229.0&lt;/Version&gt;&lt;MinVersion&gt;2.21.0.0&lt;/MinVersion&gt;&lt;Culture&gt;en-US&lt;/Culture&gt;&lt;SafeCombine&gt;false&lt;/SafeCombine&gt;&lt;Items&gt;&lt;Query Name=&quot;ExistingQuotes&quot;&gt;&lt;Formula&gt;&lt;![CDATA[let&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 1: Load the &quot;ExistingQuotes&quot; Excel table&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    Source = Excel.CurrentWorkbook(){[Name=&quot;ExistingQuotes&quot;]}[Content],&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 2: Convert column types&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    #&quot;Changed Type&quot; = Table.TransformColumnTypes(&#13;&#10;        Source,&#13;&#10;        {&#13;&#10;            {&quot;Date Pulled&quot;,     type date},&#13;&#10;            {&quot;Document Date&quot;,   type date},&#13;&#10;            {&quot;Document Number&quot;, type text},&#13;&#10;            {&quot;Customer Number&quot;, type text},&#13;&#10;            {&quot;Customer Name&quot;,   type text},&#13;&#10;            {&quot;User To Enter&quot;,   type text},&#13;&#10;            {&quot;Document Amount&quot;, type number},&#13;&#10;            {&quot;Salesperson ID&quot;,  type text},&#13;&#10;&#13;&#10;            // Old follow-up columns (to be removed):&#13;&#10;            {&quot;First F/U&quot;,       type text},&#13;&#10;            {&quot;Second F/U&quot;,      type text},&#13;&#10;            {&quot;Third F/U&quot;,       type text},&#13;&#10;            {&quot;Long-Term F/U&quot;,   type text},&#13;&#10;            {&quot;Email Contact&quot;,   type text},&#13;&#10;&#13;&#10;            // The single new override column:&#13;&#10;            {&quot;Historic Stage&quot;,  type text}&#13;&#10;        }&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 3: Remove old follow-up columns&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    #&quot;Removed Columns&quot; = Table.RemoveColumns(&#13;&#10;        #&quot;Changed Type&quot;,&#13;&#10;        {&#13;&#10;            &quot;First F/U&quot;,&#13;&#10;            &quot;Second F/U&quot;,&#13;&#10;            &quot;Third F/U&quot;,&#13;&#10;            &quot;Long-Term F/U&quot;,&#13;&#10;            &quot;Email Contact&quot;&#13;&#10;        }&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 4: Convert Document Amount to currency (optional)&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    #&quot;Changed Type1&quot; = Table.TransformColumnTypes(&#13;&#10;        #&quot;Removed Columns&quot;,&#13;&#10;        {&#13;&#10;            {&quot;Document Amount&quot;, Currency.Type}&#13;&#10;        }&#13;&#10;    )&#13;&#10;in&#13;&#10;    #&quot;Changed Type1&quot;]]&gt;&lt;/Formula&gt;&lt;IsParameterQuery xsi:nil=&quot;true&quot; /&gt;&lt;IsDirectQuery xsi:nil=&quot;true&quot; /&gt;&lt;/Query&gt;&lt;Query Name=&quot;MasterQuotes_Raw&quot;&gt;&lt;Formula&gt;&lt;![CDATA[let&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 1: Load the two existing queries (ExistingQuotes, CSVQuotes)&#13;&#10;    //         These must already exist in Power Query.&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    SourceExisting = ExistingQuotes,&#13;&#10;    SourceCSV = CSVQuotes,&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 1.1: Add a DataSource column to each query&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    ExistingWithSource = Table.AddColumn(SourceExisting, &quot;DataSource&quot;, each &quot;Legacy&quot;),&#13;&#10;    CSVWithSource = Table.AddColumn(SourceCSV, &quot;DataSource&quot;, each &quot;CSV&quot;),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 2: Append the two queries together&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    Merged = Table.Combine({ExistingWithSource, CSVWithSource}),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 3: Sort by Date Pulled (oldest to newest) then Document Amount (highest to lowest)&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    Sorted = Table.Sort(&#13;&#10;        Merged,&#13;&#10;        {&#13;&#10;            {&quot;Date Pulled&quot;, Order.Ascending},&#13;&#10;            {&quot;Document Amount&quot;, Order.Descending}&#13;&#10;        }&#13;&#10;    )&#13;&#10;in&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // Final Output: The combined and sorted table&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    Sorted]]&gt;&lt;/Formula&gt;&lt;IsParameterQuery xsi:nil=&quot;true&quot; /&gt;&lt;IsDirectQuery xsi:nil=&quot;true&quot; /&gt;&lt;/Query&gt;&lt;Query Name=&quot;CSVQuotes&quot;&gt;&lt;Formula&gt;&lt;![CDATA[let&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 1: Get all files in the target folder&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;     Source = Folder.Files(&quot;R:\Projects\Strategic Quote Recovery and Conversion Tracker (SQRCT)\30DayExports_DailyPull&quot;),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 2: Filter to only .csv files&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    OnlyCSVs = Table.SelectRows(Source, each [Extension] = &quot;.csv&quot;),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 3: For each CSV, parse with Csv.Document,&#13;&#10;    //         then skip the first row (CSV's own headers)&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    AddParsedCSV = Table.AddColumn(&#13;&#10;        OnlyCSVs,&#13;&#10;        &quot;Data&quot;,&#13;&#10;        each&#13;&#10;            let&#13;&#10;                rawCSV = Csv.Document(&#13;&#10;                    [Content],&#13;&#10;                    [&#13;&#10;                        Delimiter = &quot;,&quot;,&#13;&#10;                        Encoding = 65001,&#13;&#10;                        QuoteStyle = QuoteStyle.None&#13;&#10;                    ]&#13;&#10;                ),&#13;&#10;                // skip the very first row (header line)&#13;&#10;                removeHeaderRow = Table.Skip(rawCSV, 1)&#13;&#10;            in&#13;&#10;                removeHeaderRow&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 4: Expand that &quot;Data&quot; column&#13;&#10;    // Adjust if CSV has more/fewer columns&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    ExpandRows = Table.ExpandTableColumn(&#13;&#10;        AddParsedCSV,&#13;&#10;        &quot;Data&quot;,&#13;&#10;        {&#13;&#10;            &quot;Column1&quot;,&quot;Column2&quot;,&quot;Column3&quot;,&quot;Column4&quot;,&#13;&#10;            &quot;Column5&quot;,&quot;Column6&quot;,&quot;Column7&quot;,&quot;Column8&quot;,&quot;Column9&quot;&#13;&#10;        },&#13;&#10;        {&#13;&#10;            &quot;Batch Number&quot;,&quot;Document Date&quot;,&quot;Document Number&quot;,&#13;&#10;            &quot;Customer Number&quot;,&quot;Customer Name&quot;,&quot;Document Type&quot;,&#13;&#10;            &quot;User To Enter&quot;,&quot;Document Amount&quot;,&quot;Salesperson ID from Customer Master&quot;&#13;&#10;        }&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 5: Remove columns not needed (Batch Number, Document Type)&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    RemoveUnneeded = Table.RemoveColumns(&#13;&#10;        ExpandRows,&#13;&#10;        {&quot;Batch Number&quot;,&quot;Document Type&quot;}&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 6: Rename columns to match your final schema&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    RenameCols = Table.RenameColumns(&#13;&#10;        RemoveUnneeded,&#13;&#10;        {&#13;&#10;            {&quot;Document Date&quot;, &quot;Document Date&quot;},&#13;&#10;            {&quot;Document Number&quot;, &quot;Document Number&quot;},&#13;&#10;            {&quot;Customer Number&quot;, &quot;Customer Number&quot;},&#13;&#10;            {&quot;Customer Name&quot;, &quot;Customer Name&quot;},&#13;&#10;            {&quot;User To Enter&quot;, &quot;User To Enter&quot;},&#13;&#10;            {&quot;Document Amount&quot;, &quot;Document Amount&quot;},&#13;&#10;            {&quot;Salesperson ID from Customer Master&quot;, &quot;Salesperson ID&quot;}&#13;&#10;        }&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 7: Parse &quot;Date Pulled&quot; from the file name (e.g., SQRCT_20250210.csv)&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    AddDatePulled = Table.AddColumn(&#13;&#10;        RenameCols,&#13;&#10;        &quot;Date Pulled&quot;,&#13;&#10;        each&#13;&#10;            let&#13;&#10;                nameNoExt = Text.BeforeDelimiter([Name], &quot;.csv&quot;),  // e.g. &quot;SQRCT_20250210&quot;&#13;&#10;                datePart = Text.AfterDelimiter(nameNoExt, &quot;_&quot;)     // e.g. &quot;20250210&quot;&#13;&#10;            in&#13;&#10;                // Convert &quot;20250210&quot; =&gt; 2025-02-10&#13;&#10;                Date.FromText(datePart, [Format=&quot;yyyyMMdd&quot;])&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 8: Convert date columns to Date type&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    SetDateType = Table.TransformColumnTypes(&#13;&#10;        AddDatePulled,&#13;&#10;        {&#13;&#10;            {&quot;Date Pulled&quot;, type date},&#13;&#10;            {&quot;Document Date&quot;, type date}&#13;&#10;        }&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 9: Add F/U columns not in CSV&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    AddFUFld1 = Table.AddColumn(SetDateType, &quot;First F/U&quot;, each null),&#13;&#10;    AddFUFld2 = Table.AddColumn(AddFUFld1, &quot;Second F/U&quot;, each null),&#13;&#10;    AddFUFld3 = Table.AddColumn(AddFUFld2, &quot;Third F/U&quot;, each null),&#13;&#10;    AddFUFld4 = Table.AddColumn(AddFUFld3, &quot;Long-Term F/U&quot;, each null),&#13;&#10;    AddEmail = Table.AddColumn(AddFUFld4, &quot;Email Contact&quot;, each null),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 10: Sort by Date Pulled, then Document Date&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    SortedByDate = Table.Sort(&#13;&#10;        AddEmail,&#13;&#10;        {&#13;&#10;            {&quot;Date Pulled&quot;, Order.Ascending},&#13;&#10;            {&quot;Document Date&quot;, Order.Ascending}&#13;&#10;        }&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 11: Clean &quot;Document Amount&quot; (remove $ and commas)&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    RemoveDollars = Table.ReplaceValue(&#13;&#10;        SortedByDate,&#13;&#10;        &quot;$&quot;,&#13;&#10;        &quot;&quot;,&#13;&#10;        Replacer.ReplaceText,&#13;&#10;        {&quot;Document Amount&quot;}&#13;&#10;    ),&#13;&#10;    RemoveCommas = Table.ReplaceValue(&#13;&#10;        RemoveDollars,&#13;&#10;        &quot;,&quot;,&#13;&#10;        &quot;&quot;,&#13;&#10;        Replacer.ReplaceText,&#13;&#10;        {&quot;Document Amount&quot;}&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 12: Convert &quot;Document Amount&quot; to Currency&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    FinalCurrency = Table.TransformColumnTypes(&#13;&#10;        RemoveCommas,&#13;&#10;        {{&quot;Document Amount&quot;, Currency.Type}}&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 13: Remove leftover folder columns&#13;&#10;    // (Content, Name, Extension, Dates, Attributes, etc.)&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    RemoveFileCols = Table.RemoveColumns(&#13;&#10;        FinalCurrency,&#13;&#10;        {&#13;&#10;            &quot;Content&quot;,&quot;Name&quot;,&quot;Extension&quot;,&#13;&#10;            &quot;Date accessed&quot;,&quot;Date modified&quot;,&quot;Date created&quot;,&#13;&#10;            &quot;Attributes&quot;,&quot;Folder Path&quot;&#13;&#10;        }&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP 14: Reorder columns in final order&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    ReorderCols = Table.ReorderColumns(&#13;&#10;        RemoveFileCols,&#13;&#10;        {&#13;&#10;            &quot;Date Pulled&quot;,&#13;&#10;            &quot;Document Date&quot;,&#13;&#10;            &quot;Document Number&quot;,&#13;&#10;            &quot;Customer Number&quot;,&#13;&#10;            &quot;Customer Name&quot;,&#13;&#10;            &quot;User To Enter&quot;,&#13;&#10;            &quot;Document Amount&quot;,&#13;&#10;            &quot;Salesperson ID&quot;,&#13;&#10;            &quot;First F/U&quot;,&#13;&#10;            &quot;Second F/U&quot;,&#13;&#10;            &quot;Third F/U&quot;,&#13;&#10;            &quot;Long-Term F/U&quot;,&#13;&#10;            &quot;Email Contact&quot;&#13;&#10;        }&#13;&#10;    )&#13;&#10;&#13;&#10;    // If you want to remove those new F/U or Email columns, &#13;&#10;    // add another line:&#13;&#10;    //    Table.RemoveColumns(ReorderCols, {&quot;First F/U&quot;, &quot;Second F/U&quot;, &#13;&#10;    //                                     &quot;Third F/U&quot;, &quot;Long-Term F/U&quot;, &quot;Email Contact&quot;})&#13;&#10;&#13;&#10;in&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // Final Output&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    ReorderCols]]&gt;&lt;/Formula&gt;&lt;IsParameterQuery xsi:nil=&quot;true&quot; /&gt;&lt;IsDirectQuery xsi:nil=&quot;true&quot; /&gt;&lt;/Query&gt;&lt;Query Name=&quot;MasterQuotes_Final&quot;&gt;&lt;Formula&gt;&lt;![CDATA[let&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP A: Reference your raw data (MasterQuotes_Raw)&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    Source = MasterQuotes_Raw,&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP B: Identify the overall LatestPullDate from the entire table&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    LatestPullDate = List.Max(Source[Date Pulled]),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP C: Sort by Date Pulled (oldest to newest) then Document Amount (highest to lowest)&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    Sorted = Table.Sort(&#13;&#10;        Source,&#13;&#10;        {&#13;&#10;            {&quot;Date Pulled&quot;, Order.Ascending},&#13;&#10;            {&quot;Document Amount&quot;, Order.Descending}&#13;&#10;        }&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP D: Filter out rows where [User To Enter] is one of the undesired names&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    Filtered = Table.SelectRows(&#13;&#10;        Sorted,&#13;&#10;        each not List.Contains(&#13;&#10;            {&quot;rosannai&quot;, &quot;kathrynh&quot;, &quot;ryanz&quot;, &quot;alexandriaf&quot;},&#13;&#10;            Text.Lower([User To Enter])&#13;&#10;        )&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP E: Group by Document Number; capture:&#13;&#10;    //         - FirstPullForDoc = min date&#13;&#10;    //         - MaxPullForDoc   = max date&#13;&#10;    //         - SubRows = the rest&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    Grouped = Table.Group(&#13;&#10;        Filtered,&#13;&#10;        {&quot;Document Number&quot;},&#13;&#10;        {&#13;&#10;            {&quot;SubRows&quot;, each Table.RemoveColumns(_, {&quot;Document Number&quot;})},&#13;&#10;            {&quot;FirstPullForDoc&quot;, each List.Min([Date Pulled])},&#13;&#10;            {&quot;MaxPullForDoc&quot;, each List.Max([Date Pulled])}&#13;&#10;        }&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP F: Mark &quot;MissingInLatest&quot; if max date &lt; overall LatestPullDate&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    WithMissing = Table.AddColumn(&#13;&#10;        Grouped,&#13;&#10;        &quot;MissingInLatest&quot;,&#13;&#10;        each [MaxPullForDoc] &lt; LatestPullDate,&#13;&#10;        type logical&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP G: For each sub-table, add an &quot;Occurrence&quot; and a column carrying the&#13;&#10;    //         earliest date (FirstPullForDoc) so we can expand it later.&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    WithIndex = Table.AddColumn(&#13;&#10;        WithMissing,&#13;&#10;        &quot;IndexedSub&quot;,&#13;&#10;        each&#13;&#10;            let&#13;&#10;                tbl = [SubRows],&#13;&#10;                withOcc = Table.AddIndexColumn(tbl, &quot;Occurrence&quot;, 1, 1, Int64.Type),&#13;&#10;                withFirst = Table.AddColumn(withOcc, &quot;GroupFirstPulled&quot;, (x) =&gt; [FirstPullForDoc])&#13;&#10;            in&#13;&#10;                withFirst&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP H: Expand sub-tables (EXCLUDING the original Date Pulled),&#13;&#10;    //         bringing along &quot;GroupFirstPulled&quot; and &quot;DataSource&quot; as well&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    Expanded = Table.ExpandTableColumn(&#13;&#10;        WithIndex,&#13;&#10;        &quot;IndexedSub&quot;,&#13;&#10;        {&#13;&#10;            &quot;Document Date&quot;,&#13;&#10;            &quot;Customer Number&quot;,&#13;&#10;            &quot;Customer Name&quot;,&#13;&#10;            &quot;User To Enter&quot;,&#13;&#10;            &quot;Document Amount&quot;,&#13;&#10;            &quot;Salesperson ID&quot;,&#13;&#10;            &quot;Occurrence&quot;,&#13;&#10;            &quot;Historic Stage&quot;,&#13;&#10;            &quot;GroupFirstPulled&quot;,&#13;&#10;            &quot;DataSource&quot;&#13;&#10;        },&#13;&#10;        {&#13;&#10;            &quot;Document Date&quot;,&#13;&#10;            &quot;Customer Number&quot;,&#13;&#10;            &quot;Customer Name&quot;,&#13;&#10;            &quot;User To Enter&quot;,&#13;&#10;            &quot;Document Amount&quot;,&#13;&#10;            &quot;Salesperson ID&quot;,&#13;&#10;            &quot;Occurrence&quot;,&#13;&#10;            &quot;Historic Stage&quot;,&#13;&#10;            &quot;GroupFirstPulled&quot;,&#13;&#10;            &quot;DataSource&quot;&#13;&#10;        }&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP I: Add &quot;Auto Stage&quot; column based on Historic Stage and Occurrence&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    AddStage = Table.AddColumn(&#13;&#10;        Expanded,&#13;&#10;        &quot;Auto Stage&quot;,&#13;&#10;        each&#13;&#10;            let&#13;&#10;                hist = [Historic Stage],&#13;&#10;                occ = [Occurrence]&#13;&#10;            in&#13;&#10;                if hist = null or Text.Trim(hist) = &quot;&quot; then&#13;&#10;                    if occ = 1 then &quot;First F/U&quot;&#13;&#10;                    else if occ = 2 then &quot;Second F/U&quot;&#13;&#10;                    else if occ = 3 then &quot;Third F/U&quot;&#13;&#10;                    else &quot;Long-Term F/U&quot;&#13;&#10;                else&#13;&#10;                    hist,&#13;&#10;        type text&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP J: Add &quot;Auto Note&quot; if Historic Stage is blank and MissingInLatest is true&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    AddNote = Table.AddColumn(&#13;&#10;        AddStage,&#13;&#10;        &quot;Auto Note&quot;,&#13;&#10;        each&#13;&#10;            if ([Historic Stage] = null or Text.Trim([Historic Stage]) = &quot;&quot;) then&#13;&#10;                if [MissingInLatest] then &quot;No longer in pull—confirm converted/voided.&quot;&#13;&#10;                else null&#13;&#10;            else null,&#13;&#10;        type text&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP K: Rename columns (rename GroupFirstPulled to First Date Pulled, etc.)&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    RenameCols = Table.RenameColumns(&#13;&#10;        AddNote,&#13;&#10;        {&#13;&#10;            {&quot;Auto Stage&quot;, &quot;AutoStage&quot;},&#13;&#10;            {&quot;Auto Note&quot;, &quot;AutoNote&quot;},&#13;&#10;            {&quot;MissingInLatest&quot;, &quot;IsMissing&quot;},&#13;&#10;            {&quot;GroupFirstPulled&quot;, &quot;First Date Pulled&quot;}&#13;&#10;        }&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP K2: Clean AutoNote column to ensure blanks are empty strings and type is text&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    CleanAutoNote = Table.ReplaceValue(&#13;&#10;         RenameCols, &#13;&#10;         null, &#13;&#10;         &quot;&quot;, &#13;&#10;         Replacer.ReplaceValue, &#13;&#10;         {&quot;AutoNote&quot;}&#13;&#10;    ),&#13;&#10;    EnsureAutoNoteText = Table.TransformColumnTypes(&#13;&#10;         CleanAutoNote,&#13;&#10;         {{&quot;AutoNote&quot;, type text}}&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP L: Group by Document Number with custom aggregator to choose final row &#13;&#10;    //         based on DataSource and stage:&#13;&#10;    //         1) If any CSV row has a non-blank stage, pick the one w/ highest Occurrence&#13;&#10;    //         2) Else if any Legacy row is &quot;Converted&quot;, pick that w/ highest Occurrence&#13;&#10;    //         3) Else fallback to highest Occurrence overall&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    GroupedFinal = Table.Group(&#13;&#10;        EnsureAutoNoteText,&#13;&#10;        {&quot;Document Number&quot;},&#13;&#10;        {&#13;&#10;            {&#13;&#10;                &quot;FinalRow&quot;,&#13;&#10;                (tbl) =&gt;&#13;&#10;                    let&#13;&#10;                        csvRows         = Table.SelectRows(tbl, each [DataSource] = &quot;CSV&quot;),&#13;&#10;                        legacyRows      = Table.SelectRows(tbl, each [DataSource] = &quot;Legacy&quot;),&#13;&#10;                        csvNonBlank     = Table.SelectRows(csvRows, each [Historic Stage] &lt;&gt; null and Text.Trim([Historic Stage]) &lt;&gt; &quot;&quot;),&#13;&#10;                        chosenCSV       = if Table.RowCount(csvNonBlank) &gt; 0 then Table.Max(csvNonBlank, &quot;Occurrence&quot;) else null,&#13;&#10;                        legacyConverted = Table.SelectRows(legacyRows, each [Historic Stage] = &quot;Converted&quot;),&#13;&#10;                        chosenLegacy    = if Table.RowCount(legacyConverted) &gt; 0 then Table.Max(legacyConverted, &quot;Occurrence&quot;) else null,&#13;&#10;                        fallback        = Table.Max(tbl, &quot;Occurrence&quot;),&#13;&#10;                        finalPick       = if chosenCSV &lt;&gt; null then chosenCSV else if chosenLegacy &lt;&gt; null then chosenLegacy else fallback&#13;&#10;                    in&#13;&#10;                        finalPick&#13;&#10;            }&#13;&#10;        }&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP M: Expand the selected final row back into columns&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    ExpandedFinal = Table.ExpandRecordColumn(&#13;&#10;        GroupedFinal,&#13;&#10;        &quot;FinalRow&quot;,&#13;&#10;        {&#13;&#10;            &quot;First Date Pulled&quot;,&#13;&#10;            &quot;Document Date&quot;,&#13;&#10;            &quot;Customer Number&quot;,&#13;&#10;            &quot;Customer Name&quot;,&#13;&#10;            &quot;User To Enter&quot;,&#13;&#10;            &quot;Document Amount&quot;,&#13;&#10;            &quot;Salesperson ID&quot;,&#13;&#10;            &quot;Occurrence&quot;,&#13;&#10;            &quot;Historic Stage&quot;,&#13;&#10;            &quot;AutoStage&quot;,&#13;&#10;            &quot;AutoNote&quot;,&#13;&#10;            &quot;IsMissing&quot;,&#13;&#10;            &quot;DataSource&quot;&#13;&#10;        },&#13;&#10;        {&#13;&#10;            &quot;First Date Pulled&quot;,&#13;&#10;            &quot;Document Date&quot;,&#13;&#10;            &quot;Customer Number&quot;,&#13;&#10;            &quot;Customer Name&quot;,&#13;&#10;            &quot;User To Enter&quot;,&#13;&#10;            &quot;Document Amount&quot;,&#13;&#10;            &quot;Salesperson ID&quot;,&#13;&#10;            &quot;Occurrence&quot;,&#13;&#10;            &quot;Historic Stage&quot;,&#13;&#10;            &quot;AutoStage&quot;,&#13;&#10;            &quot;AutoNote&quot;,&#13;&#10;            &quot;IsMissing&quot;,&#13;&#10;            &quot;DataSource&quot;&#13;&#10;        }&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP N: Remove &quot;Occurrence&quot; as it's no longer needed&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    RemoveTemp = Table.RemoveColumns(ExpandedFinal, {&quot;Occurrence&quot;}),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP O: Reorder columns so that First Date Pulled is first, then Document Number, etc.&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    ReorderedColumns = Table.ReorderColumns(&#13;&#10;        RemoveTemp,&#13;&#10;        {&#13;&#10;            &quot;First Date Pulled&quot;,&#13;&#10;            &quot;Document Number&quot;,&#13;&#10;            &quot;Document Date&quot;,&#13;&#10;            &quot;Customer Number&quot;,&#13;&#10;            &quot;Customer Name&quot;,&#13;&#10;            &quot;User To Enter&quot;,&#13;&#10;            &quot;Document Amount&quot;,&#13;&#10;            &quot;Salesperson ID&quot;,&#13;&#10;            &quot;Historic Stage&quot;,&#13;&#10;            &quot;AutoStage&quot;,&#13;&#10;            &quot;AutoNote&quot;,&#13;&#10;            &quot;IsMissing&quot;,&#13;&#10;            &quot;DataSource&quot;&#13;&#10;        }&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP P: Convert date columns to date type&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    DatesFixed = Table.TransformColumnTypes(&#13;&#10;        ReorderedColumns,&#13;&#10;        {&#13;&#10;            {&quot;First Date Pulled&quot;, type date},&#13;&#10;            {&quot;Document Date&quot;, type date}&#13;&#10;        }&#13;&#10;    ),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP Q: Clean &quot;Document Number&quot; safely (avoid offset errors)&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    CleanDocNumber = Table.TransformColumns(&#13;&#10;        DatesFixed,&#13;&#10;        {&#13;&#10;            {&#13;&#10;                &quot;Document Number&quot;,&#13;&#10;                each&#13;&#10;                    let&#13;&#10;                        original     = _,&#13;&#10;                        len          = Text.Length(original),&#13;&#10;                        prefix       = if len &gt;= 5 then Text.Start(original, 5) else original,&#13;&#10;                        numericPart  = if len &gt; 5 then Text.Range(original, 5) else null,&#13;&#10;                        parsed       = try Number.From(numericPart) otherwise null,&#13;&#10;                        padded       = if parsed &lt;&gt; null then Text.PadStart(Text.From(parsed), 5, &quot;0&quot;) else &quot;&quot;&#13;&#10;                    in&#13;&#10;                        if prefix = &quot;BSMOQ&quot; then&#13;&#10;                            original&#13;&#10;                        else if parsed = null then&#13;&#10;                            original&#13;&#10;                        else&#13;&#10;                            prefix &amp; padded,&#13;&#10;                type text&#13;&#10;            }&#13;&#10;        }&#13;&#10;    ),&#13;&#10;    ChangedType = Table.TransformColumnTypes(CleanDocNumber, {{&quot;Document Amount&quot;, Currency.Type}}),&#13;&#10;&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    // STEP R: Final sort: by First Date Pulled (oldest to newest) then Document Number (alphabetically)&#13;&#10;    //////////////////////////////////////////////////////////////////////////&#13;&#10;    FinalSorted = Table.Sort(&#13;&#10;        ChangedType,&#13;&#10;        {&#13;&#10;            {&quot;First Date Pulled&quot;, Order.Ascending},&#13;&#10;            {&quot;Document Number&quot;, Order.Ascending}&#13;&#10;        }&#13;&#10;    )&#13;&#10;in&#13;&#10;    FinalSorted]]&gt;&lt;/Formula&gt;&lt;IsParameterQuery xsi:nil=&quot;true&quot; /&gt;&lt;IsDirectQuery xsi:nil=&quot;true&quot; /&gt;&lt;/Query&gt;&lt;/Items&gt;&lt;/Mashup&gt;</odc:PowerQueryMashupData>
 </odc:OfficeDataConnection>
</xml>
<style>
<!--
    .ODCDataSource
    {
    behavior: url(dataconn.htc);
    }
-->
</style>
 
</head>

<body onload='init()' scroll=no leftmargin=0 topmargin=0 rightmargin=0 style='border: 0px'>
<table style='border: solid 1px threedface; height: 100%; width: 100%' cellpadding=0 cellspacing=0 width='100%'> 
  <tr> 
    <td id=tdName style='font-family:arial; font-size:medium; padding: 3px; background-color: threedface'> 
      &nbsp; 
    </td> 
     <td id=tdTableDropdown style='padding: 3px; background-color: threedface; vertical-align: top; padding-bottom: 3px'>

      &nbsp; 
    </td> 
  </tr> 
  <tr> 
    <td id=tdDesc colspan='2' style='border-bottom: 1px threedshadow solid; font-family: Arial; font-size: 1pt; padding: 2px; background-color: threedface'>

      &nbsp; 
    </td> 
  </tr> 
  <tr> 
    <td colspan='2' style='height: 100%; padding-bottom: 4px; border-top: 1px threedhighlight solid;'> 
      <div id='pt' style='height: 100%' class='ODCDataSource'></div> 
    </td> 
  </tr> 
</table> 

  
<script language='javascript'> 

function init() { 
  var sName, sDescription; 
  var i, j; 
  
  try { 
    sName = unescape(location.href) 
  
    i = sName.lastIndexOf(".") 
    if (i>=0) { sName = sName.substring(1, i); } 
  
    i = sName.lastIndexOf("/") 
    if (i>=0) { sName = sName.substring(i+1, sName.length); } 

    document.title = sName; 
    document.getElementById("tdName").innerText = sName; 

    sDescription = document.getElementById("docprops").innerHTML; 
  
    i = sDescription.indexOf("escription>") 
    if (i>=0) { j = sDescription.indexOf("escription>", i + 11); } 

    if (i>=0 && j >= 0) { 
      j = sDescription.lastIndexOf("</", j); 

      if (j>=0) { 
          sDescription = sDescription.substring(i+11, j); 
        if (sDescription != "") { 
            document.getElementById("tdDesc").style.fontSize="x-small"; 
          document.getElementById("tdDesc").innerHTML = sDescription; 
          } 
        } 
      } 
    } 
  catch(e) { 

    } 
  } 
</script> 

</body> 
 
</html>
